<!DOCTYPE html>

<html>
<head>
  <title>destination.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="http://chrisdickinson.github.com/narrativ/base.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
          <div id="jump_page">
            
              <a href="http://chrisdickinson.github.com/narrativ//destination.js.html" class="source">destination.js</a>
            
              <a href="http://chrisdickinson.github.com/narrativ//file.js.html" class="source">file.js</a>
            
              <a href="http://chrisdickinson.github.com/narrativ//directory.js.html" class="source">directory.js</a>
            
              <a href="http://chrisdickinson.github.com/narrativ//index.js.html" class="source">index.js</a>
            
              <a href="http://chrisdickinson.github.com/narrativ//options.js.html" class="source">options.js</a>
            
              <a href="http://chrisdickinson.github.com/narrativ//parser.js.html" class="source">parser.js</a>
            
              <a href="http://chrisdickinson.github.com/narrativ//utils.js.html" class="source">utils.js</a>
            
          </div>
        </div>
      </div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              destination.js
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
          
          <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1> Destination</h1>

<p>The <code>Destination</code> class defines a general target
 for newly compiled documentation.</p>

<p>The idea is that a destination is created with knowledge
 of the base directory (the lowest common denominator directory
 of the incoming compilation request: e.g, <code>narrativ some/dir/file.js</code> would
 produce a base directory of <code>some/dir</code>).</p>

<p>It is also provided the <code>target_dir</code> -- the directory to
 emit compiled docs into. It will use <code>exec mkdir -p</code> to ensure
 that this directory exists.</p>

<p>Finally, it accepts <code>ignore_dirs</code> -- directories to omit from the final
 path. If a file has a path of <code>some/dir/application/file.js</code>, with a
 <code>base_dir</code> of <code>some/dir</code>, and an <code>ignore_dirs</code> of <code>application</code>, the resulting
 file will output into <code>{target_dir}/file.js.html</code> instead of <code>{target_dir}/application/file.js.html</code>.
 This may be removed in later versions.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">method</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./utils&#39;</span><span class="p">).</span><span class="nx">method</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">,</span>
    <span class="nx">join</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">,</span>
    <span class="nx">child_proc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">),</span>
    <span class="nx">exec</span> <span class="o">=</span> <span class="nx">child_proc</span><span class="p">.</span><span class="nx">exec</span><span class="p">,</span>
    <span class="nx">EE</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Destination</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">base_dir</span><span class="p">,</span> <span class="nx">target_dir</span><span class="p">,</span> <span class="nx">ignore_dirs</span><span class="p">,</span> <span class="nx">base_url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">base_dir</span> <span class="o">=</span> <span class="nx">base_dir</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">target_dir</span> <span class="o">=</span> <span class="nx">target_dir</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ignore_dirs</span> <span class="o">=</span> <span class="nx">ignore_dirs</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">base_url</span> <span class="o">=</span> <span class="nx">base_url</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Destination</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">target_name</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Remove the <code>base_dir</code> and any <code>ignore_dirs</code> from path,
 and concatenate that using <code>path.join</code> to our <code>target_dir</code>.
 Append <code>.html</code> to the file.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">join</span><span class="p">(</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">target_dir</span><span class="p">,</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">base_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">ignore_dirs</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="p">)</span><span class="o">+</span><span class="s1">&#39;.html&#39;</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">Destination</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rewrite_url</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Used by the <a href="http://chrisdickinson.github.com/narrativ/parser.js.html">parser</a> to link files together.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">base_url</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">target_name</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">target_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">Destination</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ensure_path</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Ensure that the full target path exists using <code>mkdir -p</code>.
 Returns an <code>EventEmitter</code> that emits either <code>ready</code> or <code>error</code>
 depending on if the action was successful.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ee</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EE</span><span class="p">();</span>

  <span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;mkdir -p &#39;</span><span class="o">+</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">ee</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">Destination</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">sections</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Use the <a href="http://chrisdickinson.github.com/narrativ/options.js.html">template file</a> to render our file.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">target_name</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">file_template</span><span class="p">.</span><span class="nx">render</span><span class="p">({</span>
    <span class="s1">&#39;destination&#39;</span><span class="o">:</span><span class="nx">self</span><span class="p">,</span>
    <span class="s1">&#39;file&#39;</span><span class="o">:</span><span class="nx">file</span><span class="p">,</span>
    <span class="s1">&#39;options&#39;</span><span class="o">:</span><span class="nx">options</span><span class="p">,</span>
    <span class="s1">&#39;sections&#39;</span><span class="o">:</span><span class="nx">sections</span><span class="p">,</span>
    <span class="s1">&#39;files&#39;</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">files</span> 
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If there's an error, pass it to the <code>options</code> error output.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>      <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create the path.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">ensure_path</span><span class="p">(</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">target</span><span class="p">)).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-8">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Write the file, passing whatever error may happen
to <code>options.error</code>. If nothing went wrong, we're done.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">html</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}).</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-9">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>If there's an error, call <code>options.error</code> with what happened.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>      <span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">Destination</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write_media</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-10">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Make sure we write the stylesheet to the appropriate location.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nx">self</span><span class="p">.</span><span class="nx">ensure_path</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">target_dir</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">target_dir</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">stylesheet</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">css_file</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-11">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Either error out or log that we wrote the file.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>      <span class="nx">err</span> <span class="o">?</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">:</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;wrote &#39;</span><span class="o">+</span><span class="nx">options</span><span class="p">.</span><span class="nx">stylesheet</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Destination</span> <span class="o">=</span> <span class="nx">Destination</span><span class="p">;</span>

</pre></div>
            </td>
          </tr>
          
      </tbody>
    </table>
  </div>
</body>
</html>
