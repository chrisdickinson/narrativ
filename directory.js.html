<!DOCTYPE html>

<html>
<head>
  <title>directory.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="base.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
          <div id="jump_page">
            
              <a href="/destination.js.html" class="source">destination.js</a>
            
              <a href="/directory.js.html" class="source">directory.js</a>
            
              <a href="/file.js.html" class="source">file.js</a>
            
              <a href="/index.js.html" class="source">index.js</a>
            
              <a href="/options.js.html" class="source">options.js</a>
            
              <a href="/parser.js.html" class="source">parser.js</a>
            
              <a href="/utils.js.html" class="source">utils.js</a>
            
          </div>
        </div>
      </div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              directory.js
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
          
          <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Directory</h1>

<p>Represents compilation targets that happen to be
 directories.</p>

<p>Handles recursion into said directories, as well as the
 creation of <a href="file.js.html">child <code>File</code> objects</a>.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./utils&#39;</span><span class="p">).</span><span class="nx">method</span><span class="p">,</span>
    <span class="nx">join</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">,</span>
    <span class="nx">EE</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">,</span>
    <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">File</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./file&#39;</span><span class="p">).</span><span class="nx">File</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Directory</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">parser</span><span class="p">,</span> <span class="nx">file_class</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Arguments are:</p>

<ul>
<li><code>path</code>: An absolute path to this directory</li>
<li><code>parser</code>: An instance of the <a href="parser.js.html">Parser class</a>.</li>
<li><code>file_class</code>: Defaults to <a href="file.js.html">File</a>, but can be overriden (for test stubbing)</li>
</ul>
            </td>
            <td class="code">
              <div class="highlight"><pre>  
  <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">parser</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">file_class</span> <span class="o">=</span> <span class="nx">file_class</span> <span class="o">||</span> <span class="nx">File</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Directory</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">destination</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Let options know we've been touched</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nx">options</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>When we receive a child, check to see whether it is a <code>Directory</code>
or a <code>File</code>, and make sure that <code>options.recurse</code> is enabled (by default, it is).
Then if it all checks out, compile the child! </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nx">self</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">Directory</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">recurse</span> <span class="o">?</span>
      <span class="nx">item</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">destination</span><span class="p">)</span> <span class="o">:</span> 
      <span class="nx">item</span> <span class="k">instanceof</span> <span class="nx">File</span> <span class="o">?</span> 
      <span class="nx">item</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">destination</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Of course, we should always let options know if there was an error grabbing our children.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">Directory</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Returns an <code>EventEmitter</code> that emits <code>data</code> once per directory child,
or <code>error</code> if there is an error reading the directory.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ee</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EE</span><span class="p">();</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">?</span> 
      <span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="o">:</span>
      <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>get the full path to the child and run <code>fs.stat</code> on it to determine
whether we're dealing with a file or a subdirectory.</p>

<p>also, if it's a file, double check that the <a href="parser.js.html">parser</a> supports it.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">join</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">err</span> <span class="o">?</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="o">:</span> 
          <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="o">?</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Directory</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">file_class</span><span class="p">))</span> <span class="o">:</span>
          <span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">?</span> <span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">self</span><span class="p">.</span><span class="nx">file_class</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parser</span><span class="p">))</span> <span class="o">:</span>
          <span class="kc">null</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">});</span>    
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">ee</span><span class="p">;</span> 
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Directory</span> <span class="o">=</span> <span class="nx">Directory</span><span class="p">;</span>

</pre></div>
            </td>
          </tr>
          
      </tbody>
    </table>
  </div>
</body>
</html>
